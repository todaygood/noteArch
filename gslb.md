#  分布式、多活数据中心如何实现DNS域名解析和负载均衡？

[ 分布式、多活数据中心如何实现DNS域名解析和负载均衡？](https://blog.csdn.net/swingwang/article/details/78636108)

DNS要做流量负载和容灾切换, 所以需要一个全局的负载均衡系统

[基于DNS的全局负载均衡（GSLB）详解（上篇）](https://blog.csdn.net/weixin_38354951/article/details/102736255)

[基于DNS的全局负载均衡（GSLB）详解（下篇）](https://blog.csdn.net/weixin_38354951/article/details/102775399?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161190129116780274155351%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=161190129116780274155351&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-2-102775399.pc_search_result_before_js&utm_term=%E8%B7%A8%E7%AB%99%E7%82%B9GSLB&spm=1018.2226.3001.4187)

## 场景

单数据中心
随着互联网的发展，企业许多业务都已经迁到线上进行，线上的应用越来越重要。最早的时候只有一个单数据中心，随着业务增多和业务的扩展，单数据中心同时接入电信、联通、移动三家运营商的线路，这个时候运营商线路之间就会出现跨网访问的问题。这种情况下，如果这个用户的宽带是联通的，我们需要自动把它引流到服务器的联通线路上，防止跨网访问的问题出现，因此会使更多用户访问网站的时候速度都比较快。在单数据中心情况下，会有在多线路之间的一个智能解析调度或者流量负载的应用，把不同的运营商分开，形成流量负载的架构。

双数据中心/两地三中心
后来慢慢随着业务进一步发展，我们发现单数据中心已经不能满足需求，便出现双数据中心或者是两地三中心的架构。
通常情况下，这两个数据中心可能是同城的，也有可能是异地的，相互作为容灾，同时也作为双活的架构。通过DNS域名解析将不同用户的流量调度到不同的数据中心来，不同数据中心也会分多条运营商线路，通过这些方式进行流量负载。
同时，如果一个数据中心运营商线路出现故障，DNS会通过自动切换的功能切换到另外一个数据中心，形成一个整体的自动检查和自动容灾切换的功能。

云扩展
随着近些年来云的发展，很多企业不仅仅是局限于自己建立的两地三中心多数据中心的架构，可能有些业务会逐渐往云上迁移，包括私有云和公有云。这个时候的技术架构就变成IDC，自建的数据中心、云及CDN的资源等混合的架构，这种情况下，如何保证数据中心的顺利运营，以及用户访问到资源的时候拥有最好的访问效果，会变得非常复杂。这就是为什么DNS要做流量负载和容灾切换的一个主要原因。

## 基于DNS的流量调度和宕机切换

流量负载方式
现在我们对基于DNS的流量负载方式进行简单介绍，域名国家工程研究中心（ZDNS）在这方面拥有许多研究成果（了解更多）。

基于地理位置的流量负载，当拥有多数据中心时，比如南方的用户可能访问到上海的数据中心，北方的用户会访问到北京的数据中心，这是一个基本的基于地理限制的流量负载或者智能解析举例。
基于运营商流量负载策略，不同的运营商会到业务系统不同线路接入的服务器上，从而避免用户跨网访问的问题。
基于权重的链路负载，一个域名可能对应两个IP地址，这两个IP按照一定的比例解析给用户进行访问。比如一个IP地址对应初始数据中心，一个IP地址对应备数据中心的流量。希望初始数据中心的流量达到70%，备数据中心的流量达到30%
还有一些自定义的负载方式。主要是一些基于流量探测的负载，比如对于流量系统进行实时探测，哪个区域的系统性能最好，会优先使用哪个地区的资源。这是通过实时的健康检查和探测做动态的流量负载的调度。

## 健康检查和宕机切换

当某数据中心出现宕机情况，为了保证用户的正常使用，要进行宕机切换操作。但是对于DNS来讲是无法感知宕机的，这时就需要额外的健康检查探测手段。在额外的服务器上部署健康检查的节点，也是基于云的架构，从不同的探测节点探测业务的可用性。通常情况下探测方式可以是基于HTTP、HTTPS、PING、TCP等，从而实现实时的发现和切换的功能。进行宕机切换时，切换可用节点的选择基于地理位置、权重、运营商、性能等。

## GSLB如何实现？

GSLB可以采用专用的F5 GTM设备，如果业务量小，也可以采用windows自带的DNS服务器，实现简单负载均衡(轮询)，GSLB跨站点负载均衡策略通常有两种。

1. 基于Local DNS请求所在的地理位置。

2. 基于GSLB与Local DNS的RTT最小。

GSLB在整个网络范围内将用户的请求定向到最近的节点(或者区域)，主要采用就近性判断，主要的方法包括DNS、应用层重定向、传输层重定向等。
然而，SLB大多在一个服务节点范围内，根据设备节点的健康性、当前负载、服务能力、分布等情况将用户的请求分配到一个具体服务节点设备。

[从底层技术来看，GSLB 究竟难在哪儿](https://blog.csdn.net/weixin_34009794/article/details/90589319?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161190129116780274155351%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=161190129116780274155351&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-1-90589319.pc_search_result_before_js&utm_term=%E8%B7%A8%E7%AB%99%E7%82%B9GSLB&spm=1018.2226.3001.4187)

[全局负载均衡（GSLB）的实现方案](https://blog.csdn.net/grace_yi/article/details/89419106?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161190218416780271556166%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=161190218416780271556166&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-89419106.pc_search_result_before_js&utm_term=%E5%BC%80%E6%BA%90GSLB&spm=1018.2226.3001.4187)



[Baidu开源的GSLB软件](https://github.com/bfenetworks/bfe),值得学习研究；文档参见: https://www.bfe-networks.net/zh_cn/  

其他的有

[polaris-gslb](https://github.com/polaris-gslb/polaris-gslb)

[PowerGSLB](https://github.com/AlekseyChudov/powergslb)